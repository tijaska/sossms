<!DOCTYPE html>
<html>
	<head>
		<title>Relay an SOS SMS</title>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel='icon' href='images/SoS.png' type='image/x-icon' />
		<link rel="manifest" href="./manifest.json?v=7" />
		<style>
			a {color: maroon}
			b {color: maroon;}
			button a {text-decoration: none; color: black;}
			div {margin: 1ex 0ex; padding: 0ex;}
			.config {background-color: #CFF; border: 1px solid #699;}
			.config p {margin: 1ex; padding: 0ex;}
			.config ul {padding: 0ex 2ex; margin: 0ex 1ex 2ex 0ex; list-style: none;}
			a {color: black; text-decoration: none; font-family: sans-serif; font-size: 80%;
				border: 1px solid #666; border-radius: 3px; background-color: #EEE; padding: 2px 6px;}
			ul {list-style: none;}
			li {margin: 5px;}
			p {margin: 12px 0px}
			table, th, td {border: 1px solid gray; border-collapse: collapse;}
		</style>
	</head>
	<body onload="init()">
		<script src="common.js"></script>
		<script>
			var cellNo = /(^\+\d{10,}$)|(0\d{8,})/;  // cell numbers may start with + (country code) or 0 (local)
			var cookies = {};
			var parameters = {};  // parameters passed in location.hash, if any
			var hub = {};  // info about teh hub, e.g. latitude and longitude
			var gotCallerLocation = false;
			function init() {  // copy cookie values into the form
				let text = document.cookie.split(';');
				for (let ii in text) {
					let bits = text[ii].split('=');
					cookies[bits[0].trim()] = bits[1];  // bits[0] may have leading space[s]
				}
				let fields = ["hubName", "hubCell", "hubCountry", "lat", "long"];  // hub fields to set from cookies
				let hubComplete = true;
				for (let ii in fields) {
					let name = fields[ii];
					if (cookies[name]) {
						hub[name] = cookies[name];
						if (document.hub[name])
							document.hub[name].value = cookies[name];
					} else {  // not all hub parameters found in cookies
						hubComplete = false;
						seeHubConfig(document.hub.hubConfig, true);  // show the hub configuration section
					}
				}  // for ii
				window.parameters = getHash();  // set caller's fields from location.hash, if passed
				// if latitude parameters present and plausible, accept caller's data
				gotCallerLocation = parameters.lat && parameters.lat >= -90 && parameters.lat <= 90
					&& parameters.long && parameters.long >= -180 && parameters.long <= 180;
				// if the caller hasn't sent lat and long, suggest sending an SMS to collect it
				byId("noCallerInfo").style.display = gotCallerLocation ? "none" : "block";
				if (cookies.lat && cookies.long) {  // if hub coordinates known,
					document.hub.hubLocation.value = prettify(cookies.lat, cookies.long);
					setHubloc(cookies.lat, cookies.long);
				} else
					geolocate();  // start locating the hub cellphone's physical position
				if (hubComplete && gotCallerLocation) {  // if the rescue hub's fields are full and we have the caller's location
					parameters.latLong = prettify(parameters.lat, parameters.long);
					fields = ["caller", "cell", "vehicle", "problem", "latLong"];
					for (let i in fields) {  // copy passsed parameters into the caller info box
						if (window.parameters[fields[i]])
							document.callerInfo[fields[i]].value = window.parameters[fields[i]];
					}
					byId("extraInfo").style.display = "table-row-group";  // show extra caller fields
//	\\				byId("askForSMS").style.display = "none";
					if (cookies.lat && cookies.long) {  // if hub coordinates found,
						document.hub.hubLocation.value = prettify(cookies.lat, cookies.long);
//	\\					showDistance();  // show the hub user how far away the caller is  // in callerURLs()
					}
					callerURLs(parameters.lat, parameters.long, "");  // set up map URLs showing caller
				} //	\\else  // no caller location
//	\\				byID("askForSMS").style.display = "block";
/*				byId("installer").addEventListener('click', async () => {
					hideInstallPromotion();  // Hide the app provided install promotion
					deferredPrompt.prompt();  // Show the install prompt
					const { outcome } = await deferredPrompt.userChoice;  // Wait for the user to respond to the prompt
					console.log("User response to the install prompt: " + outcome);  // Optionally, send analytics event with outcome of user choice
					deferredPrompt = null;  // We've used the prompt, and can't use it again, throw it away
				});	*/
			}  // init()
			/* if rescue hub's fields change, save the rescue hub's details in cookies */
			function saveHub() {
				hub.hubName = document.hub.hubName.value;
				hub.hubCountry = document.hub.hubCountry.value;
				hub.hubCell = document.hub.hubCell.value;
				if (hub.hubName != "" && hub.hubCell != "" && hub.hubCountry != "") {
					setCookie("hubName", hub.hubName, 3560);
					setCookie("hubCountry", hub.hubCountry, 3560);
					setCookie("hubCell", hub.hubCell, 3560);
					if (hub.lat)
						setCookie("lat", hub.lat, 3560);
					if (hub.long)
						setCookie("long", hub.long, 3560);
					document.hub.style = "background-color: #EFE";
					byId("extraInfo").style.display = "table-row-group";  // show extra caller details
				 } else
					byId("extraInfo").style.display = "none";  // hide extra caller details
				byId("hubFields").style.display = "none";
				document.hub.hubConfig.checked = false;
				return false;  // prevent form submission
			}
			/* set the hub location into a Google maps link */
			function setHubloc(lat, long) {
				byId("hubloc").href = "https://maps.google.com/maps?t=k&q=loc:" + lat + (long >= 0 ? "+" : "") + long;
			}
			function pasteTest() {
				document.callerInfo.in.value = `This is a test SoS SMS
Hippo Hollow, South Africa
https://maps.google.com/maps?f=q&q=(-24.81270,28.14054)`;
//	\\			document.hub.cell.value = "0123456789";
				window.scrollBy(0, 200);  // scroll down to lower lines
				return false;
			}
		/* convert a Google maps URL sent in an SMS or WhatsApp to the corresponding OpenStreetMaps URL
			See:  https://wiki.openstreetmap.org/wiki/Shortlink
		 */
		function convert() {
		try {
			if (! checkInputs())
				return false;
			var msg = document.callerInfo.in.value;
			if (msg.trim() == "")
				return err("Please paste the S<b>o</b>S SMS into the box above.");
			else
				err();  // clear error area
//	\\		window.cell = document.callerInfo.cell.value;
			let cell = document.callerInfo.cell.value;
			cell = cell ? cell.trim() : "";
			if (cell.length < 8)
				return err("Please paste the stranded driver's cell into the box above.");
			else
				err();  // clear error area
			parameters.cell = document.callerInfo.cell.value;
//			var urlLoc = msg.indexOf('https://maps.google.com/');
			// look for https://maps.google.com/ (Android) or https://www.google.com/maps (iPhone)
			var urlLoc = msg.search(/(https?:\/\/\w*\.google\.com\/)/);
			if (urlLoc == -1)
				return arr("No valid Google Maps URL found in SMS.");
			var url = msg.substr(urlLoc);
			var re = /(^.*)([\+\-]\d+\.\d+)([\+\-,]\d+\.\d+)(\S*)([\s|\S]*$)/g;  // template to find the map coordinates
			var part = re.exec(url);  // find the Google map coordinates
//			byId("whatlink").style.display = "block";
			if (part == null || part.length < 6)
				return err("No valid Google Maps URL found in SMS.");
			var lat = part[2];
			var long = part[3].substr(0, 1) == "," ? part[3].substr(1) : part[3];  // Android codes lat,long; iPhone has no , but always a sign
			parameters.lat = lat;
			parameters.long = long;
			callerURLs(lat, long, msg.substr(0, urlLoc));  // set up map URLs showing caller
			return false;  // suppress form submit
		} catch (errmsg) {
			alert(errmsg);
			debugger;
		}
		}  // convert()
		/* set map URLs to show caller */
		function callerURLs(lat, long, msg) {
			parameters.msg = msg;  // keep for fixCountry()
			var googleURL = "https://maps.google.com/maps?f=q&q=(" + lat + "," + long + ")";
			var googleSatURL = "https://maps.google.com/maps?t=k&q=loc:" + lat + (long >= 0 ? "+" : "") + long;  // satellite view
			var shortLink = makeShortCode(parseFloat(lat), parseFloat(long), 17);
			var osmurl = "https://osm.org/go/" + shortLink + "?m";
			var tips = window.location.href.substr(0, window.location.href.lastIndexOf('/')) + "/tips.html";  // help for rescue driver
			byId("previewGS").href = googleSatURL;
			byId("previewG").href = googleURL;
			byId("previewO").href = osmurl;
			var rescuer = document.callerInfo.rescueDriver.value.trim();  // rescue driver's cell number (optional)
			rescuer = rescuer.split(" ").join("").split("-").join("").split("+").join("");  // squeeze out imbedded blanks and dashes, leading +
			let text = "*SoS SMS for stranded driver:*\n" + (parameters.caller ? parameters.caller + " " : "")
				+ (parameters.cell ? parameters.cell + " " : "") + (parameters.vehicle ? parameters.vehicle + " " : "")
				+ (parameters.problem ? parameters.problem : "") + "\n" + msg;
			byId("sendWhat").href = "https://wa.me/" + (rescuer ? rescuer : "") + "?text="
				+ encode(text
				+ "\nGoogle satellite map:\n" + googleSatURL
				+ "\nGoogle street map:\n" + googleURL
				+ "\nOpen Street map:\n" + osmurl + "\n*Tips:* " + tips);
			byId("sendSMS").href = "sms://" + (rescuer ? rescuer : "") + "?body="
				+ encode(text
				+ "\nGoogle satellite map:\n" + encode(googleSatURL)
				+ "\nGoogle street map:\n" + encode(googleURL)
				+ "\nOpen Street map:\n" + encode(osmurl) + "\n*Tips:* " + tips);
			showDistance();  // show the distance between the caller and the hub
			byId("result").style.display = "";  // block
			window.scrollBy(0, 100);  // scroll down to show newly displayed lines
		}  // callerURLs()
		/* prettify +-latitide and longitude as North, South, East, West */
		function prettify(lat, long) {
			return Math.abs(lat) + "°" + (lat >= 0 ? "N" : "S") + "  " + Math.abs(long) + "°" + (long >= 0 ? "E" : "W");
		}
		/* fix the country code on a phone number; optionally fix URLs */
		function fixCountry(that, next, fixURLs) {
			if (that.value) {  // if a rescue driver's number has been supplied,
				if (that.value.match(/^0/)) {  // if number start with a zero,
					that.value = hub.hubCountry + that.value.substr(1);  // drop leading 0, prefix with country
					byId(next).innerHTML = "&nbsp; <b>Hub country code " + hub.hubCountry + " added; fix if wrong.<b>";
				} else
					byId(next).innerHTML = "";
				if (fixURLs)
					callerURLs(parameters.lat, parameters.long, parameters.msg);
			}
		}
		function OKtogo() {
			if (parameters.lat != null || parameters.long != null)  // if caller's location is known,
				return true;  // OK to go
			var msg = document.callerInfo.in.value;  // look for the caller's SoS SMS
			if (msg.trim() == "")
				return err("Please paste the caller's SoS SMS into the box above.");
		}
		function err(text) {
			byId("message").innerHTML = text;
			if (text) {
				byId("message").innerHTML = text;  // publish error message
				window.scrollBy(0, 200);  // scroll down to show error line
				return false;
			} else {
				byId("message").innerHTML = "";  // clear previous error message
				return true;
			}
		}
		function encode(arg) {
			return encodeURIComponent(arg);
		}
		function sendCallerMsg(link, type) {
			if (! checkInputs())
				return false;
			let callerCell = document.callerInfo.cell.value;
			let callerUrl= location.href/*.split("?")[0]*/.replace('hub', 'caller');  // drop ?search and #parameters, if any
			let hubURL = "rescue=" + hub.hubName + "&telno=" + hub.hubCountry+ "-" + hub.hubCell.split(" ").join("")
				+ " to get help on how to do this.";
			link.href = (type == 1 ? "sms://" + callerCell + "?body=" : "https://wa.me/" + callerCell + "?text=")
				+ encode("Please send your location to " + hub.hubName
				+ ".  Click this link: " + callerUrl + "#" + (type == 1 ? encode(hubURL) : hubURL));
			window.scrollBy(0, 200);  // scroll down to show lower lines
			return true;  // true;
		}
		function checkInputs() {
			var hubName = document.hub.hubName;
			if (hubName.value == "") {
				hubName.style = "background-color: #FCC";
				alert("Please fill in your hub's name, e.g. Control Centre");
				hubName.focus();
				return false;
			}
			setCookie("hubName", hubName.value, 365);  // keep for a year
			// full country code = optional + and 1-3 digits, optionally followed by - and another 1-3 digits, e.g. +1-242 = Bahamas
			// needs regexp /^\+?\d{1,3}$|^\+?\d{1,3}-\d{1,3}$/, but we will ignore hyphenated country codes for now.
			if (! checkCell(document.hub.hubCountry, /^\+\d{1,3}$/, "Please fill in your country's phone code"))
				return false;
			if (! checkCell(document.hub.hubCell, cellNo, "Please fill in your hub's cell number"))
				return false;
			if (! checkCell(document.callerInfo.cell, cellNo, "Please fill in the stranded driver's cell number"))
				return false;
			return true;  // passed all checks
		}
		function setCookie(name, value, max_age) {
			document.cookie = name + "=" + value + "; max-age=" + max_age * 3600 * 24;
		}
		function checkCell(cellNo, pattern, text) {  // check a cell number in the form
			var fixed = cellNo.value.split(/[\s-]/).join('');  // strip out blanks and dashes
			if (fixed == '')
				return badCell(cellNo, text);
			if (fixed.match(pattern) == null)
				return badCell(cellNo, cellNo.name + " looks odd");
			cellNo.style = "background-color: white";
			// keep hubName, hubCell and country cookies for a year; sender for an hour
			setCookie(cellNo.name, fixed, 3600 * (cellNo.name == "sender" ? 1 : 24 * 365));
			return true;
		}
		function badCell(field, text) {
			field.style = "background-color: #FCC";
			alert(text);
			field.focus();
			return false;
		}
		function fixUnitCell(that) {
			var fixed = that.value.split(/[\s-]/).join('');  // strip out blanks and dashes
			if (fixed == '') {
				alert("Please fill in your hub's cell number");
				that.focus();
			} else
				if (fixed.length < 10) {
					alert("That cell number looks too short");
					that.focus();
				} else
					if (fixed.match(/^\+?\d*$/) == null) {
						alert("Cell number must be numeric with optional leading +");
						that.focus();
					} else
						document.cookie = "hubCell=" + fixed;
		}
		/** hub operator no longer provides driver's cell no; use SMS or WhatsApp contact picker instead.
		function driverChange() {  // invoked if the user changes the rescue vehicle driver's phone number
			byId("result").style.display = "none";  // hide SMS conversion results again
		}	*/
		/** show or hide hub fields */
		function seeHubConfig(checkbox, setting) {
			let showtime = typeof setting != "undefined" ? setting : checkbox.checked;  // true if setting == true or checkbox is checked
			checkbox.checked = showtime;
			byId("hubFields").style.display = showtime ? "block" : "none";
		}
		/** get the browser's physical coordinates */		
		function geolocate() {
			byId("geoloc").style.display = "block";
			let options = {timeout: 5000 /* msec */};
			if (navigator.geolocation)
				navigator.geolocation.getCurrentPosition(onPositionGot, onPositionFail, options);
			else {
				byId("geoloc").innerHTML = "<b>Your browser can't get your location. "
					+ "Sorry, you can't use this app to determine your location.</b>";
			}
			return false;  // inhibit form submission
		}  // geolocate()
		/** This function is called if/when geolocation completes.
		 * Compute distance between caller and hub using the Haversine formula. */
		function onPositionGot(position) {
			hub.lat = round5(position.coords.latitude);
			hub.long = round5(position.coords.longitude);
			let latLong = prettify(hub.lat, hub.long);  //Math.abs(hub.lat) + "° " + (hub.lat >= 0 ? "north, " : "south, ")  // &deg;
				// + Math.abs(hub.long) + "° " + (hub.long >= 0 ? "east" : "west");
			byId("geoloc").innerHTML += "<br>" + latLong;
			document.hub.hubLocation.value = latLong;
			saveHub();  // save the latitude and longitude
			setHubloc(hub.lat, hub.long);
			seeHubConfig(document.hub.hubConfig, true);  // show hub details
			showDistance();
		}
		/** this function is called if/when geolocation fails */
		function onPositionFail(err) {
			byId("geoloc").innerHTML = "<b>Geolocation failed. Sorry, you can't use this app to send your location to the rescue centre.  "
				+ "Your browser can't locate its position.</b><br><span style='color: gray'>" + err.message + "</span>";
		}/* show the hub user how far away the caller is */
		function showDistance() {
			let km = Math.round(distance(hub.lat, hub.long, parameters.lat, parameters.long) * 10) / 10;
			let far = (km > 10 ? true : false);  // because let km = far > 10 doesn't work!!
			let bear = Math.round(bearing(hub.lat, hub.long, parameters.lat, parameters.long));
			byId("distance").innerHTML = (far ? "<b>" : "") + "The caller is " + km + " km from you, bearing: "
				+ bear + "°" + (far ? "</b>" : "")
				+ '&nbsp; <img src="images/arrow18.png" style="transform: rotate(' + bear + 'deg); vertical-align: bottom">';
			byId("distance").style = far ? "display: inline; font-style: italic; font-weight: bold; background-color: #FEE;" : "";
//	\\		byId("distance").style.display = "inline";
		}
		function round5(num) {  // return num rounded to 5 decimals
			return Math.round(num*100000) / 100000;
		}
		function delCookie(name) {
			document.cookies = name + "=;max-age=0";
		}
		// from https://web.dev/customize-install/
/*		var deferredPrompt;  // Initialize deferredPrompt for use later to show browser install prompt.
		window.addEventListener('beforeinstallprompt', (evt) => {
			evt.preventDefault();  // Prevent the mini-infobar from appearing on mobile
			deferredPrompt = evt;  // Stash the event so it can be triggered later.
			byId("installer").style.display = "block";  // Update UI notify the user they can install the PWA
			window.scrollBy(0, 200);  // scroll down to show lower lines
			console.log(`'beforeinstallprompt' event was fired.`);  // Optionally, send analytics event that PWA install promo was shown.
		});	*/
	</script>
	<h2>Relay an S<b>o</b>S SMS from a stranded driver to a rescue vehicle driver</h2>
		<h4>This app helps you to get a stranded driver to send you an S<b>o</b>S SMS with their location attached, so you can
			send it on to a rescue vehicle driver. &nbsp; <a href="index.html">See here</a> how to use it.</h4>
		<form name="hub" onsubmit="return false;">
			<div class="config">
				<p style="font-weight: bold;"><input type="checkbox" name="hubConfig" onclick="seeHubConfig(this)">
					&nbsp;Check or change the hub configuration</p>
				<ul id="hubFields" style="display: none;">
				<li>Enter or fix the name of your hub:<br>
				<input style="background-color: #FFE" type="text" name="hubName" size="30"></li>
				<li>Enter your hub's phone country code, e.g.&nbsp;+27&nbsp;for&nbsp;South&nbsp;Africa:<br>
				<input style="background-color: #FFE" type="text" name="hubCountry" size="4"></li>
				<li>Enter your hub's cell number:<br>
					<input style="background-color: #FFE" type="text" name="hubCell" size="13"></li>
				<li>Your hub's location is:<br>
					<input style="background-color: #FFE" type="text" name="hubLocation" size="30" onfocus="this.blur()"></li>
				<li style="margin: 1ex 0ex"><a id="hubloc" href="?" target="_blank">Click this Google maps link</a>
					and make sure that your hub's location is right.
					If it isn't, please take the phone outdoors and <a href="" onclick="return geolocate()">click&nbsp;here</a> to try get the location right.</li>
				<li style="margin: 1ex 0ex"><a href="" onclick="return saveHub();">Update</a> if you change anything.</li>
			</ul>
			</div>
		</form>
		<p><i><span id="geoloc" style="display: none">Getting your location...</span></i></p>
		<form name="callerInfo" onsubmit="return false;">
			<div id="noCallerInfo">The stranded driver's location was not passed. You can send them an
				<a href="" target="_blank" onclick="return sendCallerMsg(this, 1)">SMS</a> or
				<a href="" target="_blank" onclick="return sendCallerMsg(this, 2)">WhatsApp</a> that contains a web link.
				When they click it, it will help them to send their location and other details back to you.
				<br>If that doesn't work for them, <a href="callerHelp.html?control" target="_blank">click&nbsp;here</a> to see how you can tell them
				by phone what to do.
			<div>If the stranded driver has sent you an SMS or WhatsApp with their location attached, paste the whole message into the box below:<br>
				<i>(or <a href="" onclick="return pasteTest();">paste a test S<b>o</b>S SMS</a> to test)</i>
				<p><textarea name="in" cols="40" rows="6" onchange="convert()"></textarea></p>
				<p><a href="" onclick="return convert()">Process</a> the pasted S<b>o</b>S SMS or WhatsApp</p>
			</div></div>
			<table style="background-color: #FFE;" border="1" cellspacing="0">
				<tbody>
				<tr><td colspan="2" style="font-weight: bold;">The stranded driver's details:</td></tr>
				<tr><td>Cell number:</td><td><input type="text" name="cell" size="25" onchange="fixCountry(this, 'callerCountry', false)">
					<span id="callerCountry"></span></td></tr>
				</tbody>
				<tbody style="display: none;" id="extraInfo">
				<tr><td>Name:</td><td><input type="text" name="caller" size="25">
				<tr><td>Vehicle:</td><td><input type="text" name="vehicle" size="25"></td></tr>
				<tr><td>Problem:</td><td><input type="text" name="problem" size="25"></td></tr>
				<tr id="location"><td valign="top">Location:</td><td><input type="text" name="latLong" size="25">
				</tbody>
			</table>
			<ul id="result" style="display: none; padding: 1ex 0ex; margin: 0px; list-style: none;">
				<li id="distance" style="font-style: italic; font-weight: bold;"></li>
				<!--li>If the rescue driver you choose isn't in your phone's contacts, please enter their cell number:
				<br><input type="text" name="rescueDriver" onchange="fixCountry(this, 'driverCountry', true)">
				<span id="driverCountry"></span></li-->
				<li><strong>Relay the stranded driver's info to a rescue driver.</strong>
					<br>If the rescue driver (or rescue WhatsApp group) that you want to send to is already in your contacts,
					click to send them the caller's details:</li>
				<li>by &nbsp;<a id="sendWhat" href="" target="_blank" onclick="return OKtogo()">WhatsApp</a>&nbsp;
				or by &nbsp;<a id="sendSMS" href="" target="_blank" onclick="return OKtogo()">SMS</a></li>
				<li>Else fill in the chosen rescue driver's cell number, then click buttons above:
				<br><input type="text" name="rescueDriver" onchange="fixCountry(this, 'driverCountry', true)">
				<span id="driverCountry"></span></li>
				<!--li>If the recipient isn't in your contacts, please enter their cell number
				(with country code if a WhatsApp e.g. +271234567890) before clicking the button:
/*	*/			<br><input type="text" name="rescueDriver2"></li-->
				<li>Optionally, see the caller's location in:</li>
				<li><a id="previewGS" target="_blank" href="">Google satellite view</a>&nbsp; or &nbsp;
					<a id="previewG" target="_blank" href="">Google street map</a>&nbsp; or &nbsp;
					<a id="previewO" target="_blank" href="">Open Street map</a>
				</li>
			</ul>
			<div id="message" style="font-weight: bold;"></div>
			<div id="installer" style="display: none; font-weight: bold;" onclick="install()">Install this app</div>
		</form>
	</body>
</html>
