<!DOCTYPE html>
<html>
	<head>
		<title>Relay an SOS SMS</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel='icon' href='SoS.png' type='image/x-icon'><!-- favicon.ico -->
	</head>
	<body>
		<script>
			function pasteTest() {
				document.aform.in.value = `This is a test SMS
Hippo Hollow, South Africa
https://maps.google.com/maps?f=q&q=(-24.81270,28.14054)
from cell 080-111-2222`;
				return false;
			}
			function byId(id) {
				return document.getElementById(id);
			}
		/* convert a Google maps URL to the corresponding OpenStreetMaps URL
			See:  https://wiki.openstreetmap.org/wiki/Shortlink
		 */
		function convert() {
//			byId("result").style.display = "block";
			var message = byId("message");
//			var outg = byId("outg");
			var msg = document.aform.in.value;
			var urlLoc = msg.indexOf('https://maps.google.com/');
			if (urlLoc == -1) {
				message.innerHTML = "No valid Google Maps URL found in SMS.";
				return false;
			}
			var re = /(^[\s|\S]*)(https:\/\/maps\.google\.com\/)(.*)\((.*),(.*)\)([\s|\S]*$)/;  // template to parse the SMS
			var part = re.exec(msg);  // find the Google map URL and coordinates; look for "q=(lat,long)"
			if (part == null || part.length < 6) {
				message.innerHTML = "Google Map coordinates are invalid.";
				return false;  // suppress form submit
			}
			var googleURL = part[2] + part[3] + "(" + part[4] + "," + part[5] + ")";
			var tmp2 = part[1] + googleURL + part[6];
			
			var url = msg.substr(urlLoc);
			var coords = /q=\((.*),(.*)\)([\s|\S]*$)/.exec(url);  // look for coordinates "q=(lat,long)"
			if (coords == null || coords.length < 3) {
				message.innerHTML = "Google Map coordinates are invalid.";
				return false;  // suppress form submit
			}
			var googleURL = coords[3];
			var trailer = coords[3] ? coords[3] : "";  // coords[3] is the text following the Google maps URL, if any
			var shortLink = makeShortCode(parseFloat(coords[1]), parseFloat(coords[2]), 17);
			var osmurl = "https://osm.org/go/" + shortLink + "?m";
//			outg.href = outg.innerHTML = url;
			byId("previewG").href = url;
			byId("previewO").href = osmurl;
			byId("sendWhat").href = "https://wa.me/+27825704803?text="
				+ encodeURIComponent(msg.substr(0, urlLoc) + "Google map:\n" + url
				+ "\nOpen street map:\n" + osmurl + trailer);
//				var outo = byId("outo");
//				outo.href = outo.innerHTML = "https://osm.org/go/" + shortLink + "?m";  // ?m requests a map marker
			byId("result").style.display = "block";
			return false;  // suppress form submit
		}
		/* Called to create a short code for the short link */
		function makeShortCode(lat, lon, zoom) {
			var char_array = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_~";
			var x = Math.round((lon + 180.0) * ((1 << 30) / 90.0));
			var y = Math.round((lat +  90.0) * ((1 << 30) / 45.0));
			// JavaScript only has to keep 32 bits of bitwise operators, so this has to be
			// done in two parts. each of the parts c1/c2 has 30 bits of the total in it
			// and drops the last 4 bits of the full 64 bit Morton code.
			var str = "";
			var c1 = interlace(x >>> 17, y >>> 17), c2 = interlace((x >>> 2) & 0x7fff, (y >>> 2) & 0x7fff);
			for (var i = 0; i < Math.ceil((zoom + 8) / 3.0) && i < 5; ++i) {
				digit = (c1 >> (24 - 6 * i)) & 0x3f;
				str += char_array.charAt(digit);
			}
			for (var i = 5; i < Math.ceil((zoom + 8) / 3.0); ++i) {
				digit = (c2 >> (24 - 6 * (i - 5))) & 0x3f;
				str += char_array.charAt(digit);
			}
			for (var i = 0; i < ((zoom + 8) % 3); ++i) {
				str += "-";
			}
			return str;
		}
		/* Called to interlace the bits in x and y, making a Morton code */
		function interlace(x, y) {
			x = (x | (x << 8)) & 0x00ff00ff;
			x = (x | (x << 4)) & 0x0f0f0f0f;
			x = (x | (x << 2)) & 0x33333333;
			x = (x | (x << 1)) & 0x55555555;
			y = (y | (y << 8)) & 0x00ff00ff;
			y = (y | (y << 4)) & 0x0f0f0f0f;
			y = (y | (y << 2)) & 0x33333333;
			y = (y | (y << 1)) & 0x55555555;
			return (x << 1) | y;
		}
	</script>
	<h2>Relay an S<span style="color: red;">o</span>S SMS</h2>
		<form name="aform" onsubmit="return false;">
			<p>Paste the SMS containing the Google Maps link,<br>
				plus the cell number of the person needing help.<br>
				(or <button onclick="return pasteTest();">paste a test SMS</button>):</p>
			<p><textarea name="in" cols="40" rows="10"></textarea></p>
			<p><button onclick="return convert()">Convert the SMS into a WhatsApp</button></p>
			<ul id="result" style="display: none;">
				<li><a id="previewG" target="_blank" href="">Preview the Google map</a></li>
				<li><a id="previewO" target="_blank" href="">Preview the Open Street map</a></li>
				<li><a id="sendWhat" href="" target="_blank">Send the WhatsApp</a></li>
			</ul>
			<!--p><b><a id="outg" href="" target="blank">?</a></b><br>
				The corresponding OpenStreetmaps URL is: &nbsp;
				<b><a id="outo" href="" target="blank">?</a></b></p-->
			<p id="message" style="font-weight: bold"></p>
		</form>
	</body>
</html>
